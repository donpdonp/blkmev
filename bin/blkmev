#!/usr/bin/env perl6

use v6;
use lib './lib';
use BlkMeV;
use BlkMeV::Net;
use BlkMeV::Protocol;
use BlkMeV::Chain;
use BlkMeV::Header;

sub MAIN ( Str $chain_name =  "bitcoin", Str $ahost = "" ) {

  my $chain = BlkMeV::Chain::Chain.new(name => $chain_name);
  my $supplier = Supplier.new;
  my $supply = $supplier.Supply;
  my $socket;
  my $master_switch = Channel.new;

  BlkMeV::Protocol::<$chain> = $chain;

  my $host = $ahost.chars > 0 ?? $ahost !! $chain.host;
  say "connecting {$host}:{$chain.port}";


  IO::Socket::Async.connect($host, $chain.port).then( -> $promise {
    CATCH { default { say .^name, ': ', .Str } };
    $socket = $promise.result;
    say "connected to {$socket.peer-host}:{$socket.peer-port}";
    my $header = BlkMeV::Header::Header.new;
    $header.fromStr("+connect");
    $supplier.emit(($socket, $chain, $header, Buf.new()));
    BlkMeV::Net::read_loop($socket, $chain, $supplier, $master_switch);
  });

  $supply.tap( -> ($socket, $chain, $header, $payload) {
    BlkMeV::Net::dispatch($socket, $chain, $header, $payload)
  });

  $master_switch.receive; # wait forever
}

=begin pod
=head1 USAGE
$ blkmev
=end pod

